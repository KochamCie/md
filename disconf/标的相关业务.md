

[TOC]

## 标的生成

### 1.快速下单/推标

🔪生成业务申请

- tb_loanrequest、tb_loanrequest_detail

🔪经过审标审核通过后--创建初始标的

- tb_loan

🔪发标--创建标的账户

- tb_ump_tender==》联动标的账户

🔪调度--开标

- tb_loan标的状态的改变



## 投标

### 1.资金

- 投资人的联动账户金额--转出
- 标的账户金额--转入
- 未结标前投资人可用余额冻结

### 2.记录

- tb_user_fund

- tb_invest

- tb_fund_record

  ​



## 满标-结标

### 1.计算

- 计算利息及还款日期


- 投资人回款计划
- 借款人还款计划

### 2.资金

- 标的账户金额--转出
- 借款人联动账户金额--转入

|  账户   | 转账方向 |  账户   |  资金记录   |
| :---: | :--: | :---: | :-----: |
| 标的账户  |  转出  | 借款人账户 |   放款    |
| 借款人账户 |  转出  |  平台   | 管理费、服务费 |
| 借款人账户 |  转出  |  担保方  |   担保费   |
| 借款人账户 |  转出  | 资金使用方 |         |
|       |      |       |         |
|       |      |       |         |



- ​
- 一些服务费、担保费、管理费转出
- 投资人冻结部分解冻

### 3.记录

- tb_user_fund
- tb_invest
- tb_invest_repayment
- tb_fund_record
- tb_loan
- tb_loan_repayment




## 还款/垫付

### 1.按时正常还款

### 2.提前还款



- | **按时正常还款** | 不同的页面/接口 \|\|相同接口不同的分支 |      |
  | ---------- | :--------------------: | ---- |
  | 借款人正常还款    |   借款人账户--标的账户--投资人账户   |      |
  | 担保方垫付还款    |   担保方账户--标的账户--投资人账户   |      |
  | 平台垫付还款     |   平台放账户--标的账户--投资人账户   |      |
  |            |                        |      |
  | **提前还款**   |                        |      |
  | 借款人提前还款    |                        |      |
  | 担保方提前垫付    |                        |      |
  | 平台提前垫付     |                        |      |
  |            |                        |      |

## 处理过的问题

### 1.投标

- 标的[周周盈-170415-001]联动记录投标人数为440，本地记录为438。不一致对结标有影响，需要同步为联动方的记录数。
- 标的缺少投标记录
- 用户投标生成冻结记录失败

### 2.结标

- 缺少还款还款计划记录 及修改标的状态为已结算
- tb_loan状态不为已结算
- 未生成放款记录
- https://shimo.im/doc/HOKJjgsJ7mE5oGDn

### 3.还款

- 还款计划状态未更新成已还，缺少借款人还款资金LOAN_REPAY记录
- 标的账户转账失败

### 4.资金存留在标的账户

结标或者还款都有可能发生。

- 标的唯一号[HS5-03-170424-005 ],垫付还款时amount:1022.10 umpRetCode:00020000 umpRetMsg:查询投资关系异常！]导致投资用户缺少回款记录、回款计划状态未更新、可用余额未更新、标的还款计划(第5期)未更新  
- 某一笔还款至投资人联动返回系统繁忙



## 解决问题的思路

1. 不论是前台操作还是后台操作，问清楚后确定好调用的接口
   - 从日志入手，找到操作的日志记录的起始处排查出现的原因
   - 比如还款，选择不同的还款方式可能走的逻辑不一样，需要结合接口内容及其日志来排查原因
2. 淡定
3. 确定是否是部分成功
   - 以上业务场景的几方角色的资金交互都有通过标的账户
   - 在npc后台查看标的账户流水记录来确认这次结标或者还款标的账户金额是否全部转出或者转入
   - 对比借款列表--标的详情--投标记录~~投标状态
   - 对比投资人回款计划、借款人还款计划
   - 对比资金记录
4. 部分成功，标的账户留有余额
   - 找出哪一笔或者哪几笔有问题、splunk查日志可查到原因
   - 再三确认是否是这些投资人
   - 确认各个记录
5. 少还款计划
   - 应还日期可以参考投资人收款计划的回款日期






## 附录

### 1.标的还款方式

```java
BulletRepayment("一次性还本付息", "短期首选", true, "一次性还本付息"),	// 41094笔
MonthlyInterest("按月付息到期还本", "还款压力小", true, "按期付息到期还本"),	// 1183笔
EqualInstallment("按月等额本息", "还款便捷", true, "等额本息"),	// 2笔
EqualPrincipal("按月等额本金", "总利息最低", true, "等额本金"),	// 4笔
EqualInterest("月平息", "实际利率最高", true, "平息"),	// 598笔
@Deprecated
YearlyInterest("按年付息到期还本", "还款压力小", false, null);	// 0笔
```



### 2.提前还款方式

- 剩余全额本金及当期全额利息
- 剩余全额本金
- 剩余全额本金及按天计算利息